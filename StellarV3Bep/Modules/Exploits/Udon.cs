using StellarV3Bep.SDK.Utils;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UnityEngine;
using VRC.Udon;

namespace StellarV3Bep.Modules.Exploits
{
    internal class Udon
    {
        private static string logFilePath;

        public static IEnumerator LogUdonEvents()
        {
            string worldName = "UnknownWorld";
            if (RoomManager.field_Internal_Static_ApiWorld_0 != null)
            {
                worldName = RoomManager.field_Internal_Static_ApiWorld_0.name;
                worldName = RemoveInvalidFileChars(worldName);
            }

            logFilePath = Path.Combine(Main.logFolderPath, $"UdonLog_{worldName}.txt");

            var logEntries = new List<string>();
            logEntries.Add($"---- Udon Event Log ({System.DateTime.Now}) ----\n");

            foreach (UdonBehaviour udonBehaviour in UnityEngine.Object.FindObjectsOfType<UdonBehaviour>())
            {
                string GetHierarchyPath(Transform t)
                {
                    string path = t.name;
                    Transform parent = t.parent;

                    while (parent != null)
                    {
                        path = parent.name + "/" + path;
                        parent = parent.parent;
                    }

                    return path;
                }

                logEntries.Add($"[UdonBehaviour] {GetHierarchyPath(udonBehaviour.transform)}");

                foreach (var keyValuePair in udonBehaviour._eventTable)
                {
                    if (keyValuePair.Key.StartsWith("_"))
                        continue;

                    logEntries.Add($"    Event: {keyValuePair.Key}");
                }

                logEntries.Add("");
                yield return null;
            }

            logEntries.Add("\n---- End of Log ----\n");

            File.AppendAllLines(logFilePath, logEntries);
            PopupUtils.HudMessage("UdonLog", $"Udon events have been logged to {logFilePath}", 3f);
        }

        private static string RemoveInvalidFileChars(string filename)
        {
            char[] invalidChars = Path.GetInvalidFileNameChars();
            foreach (char c in invalidChars)
            {
                filename = filename.Replace(c.ToString(), "_");
            }
            return filename;
        }
    }
}
